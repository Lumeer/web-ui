<ng-container
  *ngIf="{permissions: view | viewControlsInfo:(projectPermissions$ | async):(collectionsPermissions$ | async):(viewsPermissions$ | async):(linkTypes$ | async), viewChanged: viewChanged$ | async} as state">
  <ng-container
    *ngIf="{disabled: (saveLoading$ | async) || !(name && (!view.code || state.viewChanged) && state.permissions.canSave)} as buttonsData">
    <form class="view-controls-grid">
      <div class="perspective d-flex align-items-center justify-content-start">
        <div class="input-group flex-nowrap me-2 mb-2" data-tour="perspective">
        <span class="input-group-text">
          <strong *ngIf="novice"
                  i18n="@@view.perspective.guide.select">1.&nbsp;Select View</strong>
          <i *ngIf="!novice"
             class="far fa-eye fa-fw">
          </i>
        </span>
          <ng-container *ngIf="perspective$ | async as perspective">
            <button aria-expanded="false" aria-haspopup="true" type="button" #perspectiveElement
                    class="btn btn-outline-gray-600 sharp-top-left sharp-bottom-left dropdown-toggle"
                    [disabled]="view?.id && !state.permissions.canConfig"
                    (click)="onPerspectiveChooserClick($event)">
              <i class="fa-fw {{perspective | perspectiveIcon}}"></i>
              <span class="ms-sm-1 text-nowrap">{{perspective | perspectiveName}}</span>
            </button>

            <hint *ngIf="displayPerspectiveHint$ | async"
                  class="position-relative"
                  (dismissHint)="onHintDismissed('perspective')"
                  title="Change View type"
                  i18n-title="@hint.perspective.title">
              <span i18n="@@hint.perspective.content">Change the way how your data are visually represented. You can pick various options, such as a calendar, timeline, chart, map, kanban board, and many others! You can even have multiple views showing the same table â€“ so quite literally see the very same data in many different ways.</span>
            </hint>

            <options-dropdown
              [closeOnClickOrigin]="true"
              [showBackdrop]="false"
              [origin]="perspectiveElement"
              [options]="perspectives | sortPerspectives | perspectivesOptions"
              [highlightedValue]="perspective"
              (selectOption)="onSelectPerspective($event.value, state.permissions.canConfig)">
            </options-dropdown>
          </ng-container>
        </div>

        <i *ngIf="novice"
           class="view-arrow fas fa-arrow-circle-right me-2 mb-2 text-muted">
        </i>
      </div>

      <div class="view-name input-group flex-nowrap flex-fill mb-2" data-tour="view">
      <span class="input-group-text">
        <strong *ngIf="novice"
                i18n="@@view.perspective.guide.title">2.&nbsp;Set Title</strong>
        <i *ngIf="!novice"
           class="far fa-file-edit fa-fw">
        </i>
      </span>
        <input #viewNameInput
               [class.fst-italic]="!view.code || view.name !== name"
               [value]="name"
               [disabled]="view && !state.permissions.canSave"
               (input)="onNameInput(viewNameInput.value)"
               id="viewName"
               name="viewName"
               (blur)="onInputBlur(state.permissions.canSave)"
               (keyup)="onViewNameKeyPress(!buttonsData.disabled, $event, state.permissions.canClone, viewNameInput)"
               type="text"
               class="form-control"
               autocomplete="off"
               placeholder="Type a title of this page, save, and share!" i18n-placeholder="@@view.untitled">
        <div class="input-group-append d-flex">
          <button [disabled]="buttonsData.disabled"
                  class="btn rounded-0"
                  [class.btn-primary]="!buttonsData.disabled"
                  [class.btn-outline-secondary]="buttonsData.disabled"
                  [class.disabled]="buttonsData.disabled"
                  type="button"
                  title="Save" i18n-title="@@button.save"
                  (click)="onSave(state.permissions.canClone)">
            <i class="fas fa-save"></i>
          </button>
          <hint *ngIf="displaySaveViewHint$ | async"
                class="position-relative"
                (dismissHint)="onHintDismissed('save')"
                title="Save the View"
                i18n-title="@hint.saveView.title">
            <span i18n="@@hint.saveView.content">Give your view a name so that you can later easily find it and open it again. Along with editing the view and the query above to your liking, you can save the view using this button. You will then see this new or renamed view on the project home screen, together with other views.</span>
          </hint>

          <button *ngIf="canShareView"
                  [disabled]="!(view.code && state.permissions.canShare)"
                  (click)="onShareClick()"
                  class="btn btn-primary rounded-0 rounded-end"
                  type="button">
            <span i18n="@@button.share"
                  placement="left"
                  tooltip="To share a view, first set its name and save it using the controls to the left."
                  i18n-tooltip="@@view.share.disabled.tooltip"
                  [isDisabled]="!!view.code || state.permissions.canShare">Share</span>
          </button>
          <hint *ngIf="displayShareViewHint$ | async"
                class="position-relative"
                (dismissHint)="onHintDismissed('share')"
                title="Share the View"
                i18n-title="@hint.shareView.title">
            <span i18n="@@hint.shareView.content">Share your new view with your colleagues and co-workers so that you can collaborate instantly. They do not need to see all the underlying data. A view can also provide only a limited peek into the whole table.</span>
          </hint>
        </div>
      </div>
    </form>
    <div *ngIf="state.viewChanged && state.permissions.canSave"
         class="small text-end text-warning">
      <i class="far fa-exclamation-triangle me-1 text-warning"
         title="Changes are not saved yet!" i18n-title="@@view.changes.not.saved">
      </i>
      <span class="text-warning" i18n="@@view.changes.not.saved">Changes are not saved yet!</span>
      <span *ngIf="!buttonsData.disabled"
            class="btn-link text-success ms-1 cursor-pointer text-underline" (click)="revertChanges()"
            i18n="@@view.changes.not.saved.undo">Undo changes</span>
    </div>
  </ng-container>
</ng-container>
