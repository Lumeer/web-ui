<ng-container *ngIf="{document: document$ | async, collection: collection$ | async, currentUser: currentUser$ | async, constraintData: constraintData$ | async} as data">

  <form-documents-choose class="mb-4 d-block"
                         *ngIf="mode === modeType.Update"
                         [collection]="data.collection"
                         [documentId]="data.document?.id"
                         [attributesSettings]="attributesSettings"
                         [constraintData]="data.constraintData"
                         [query]="query"
                         [view]="view"
                         (selectDocument)="selectDocument($event)">
  </form-documents-choose>

  <ng-container *ngIf="mode | isFormViewVisible:data.document">

    <form-view-section *ngFor="let section of config?.sections; trackBy: trackBySection; let index = index; let first = first"
                       class="d-block card p-3 shadow-light"
                       [class.mt-3]="mode === modeType.Update || !first"
                       [dataValues]="documentDataValues$ | async"
                       [linkValues]="linkData$ | async"
                       [section]="section"
                       [collection]="data.collection"
                       [documentId]="data.document?.id"
                       [editable]="data.document | dataResourceIsWritable:data.collection:collectionPermissions:data.currentUser:data.constraintData"
                       [formErrors]="(validation$ | async)?.errors | formErrorsBySection:section.id"
                       (attributeValueChange)="onAttributeValueChange($event)"
                       (linkValueChange)="onLinkValueChange($event)">
    </form-view-section>

    <form-view-submit class="mt-4"
                      [editable]="data.document | dataResourceIsWritable:data.collection:collectionPermissions:data.currentUser:data.constraintData"
                      [deletable]="data.document | dataResourceIsDeletable:data.collection:collectionPermissions:data.currentUser:data.constraintData"
                      [document]="data.document"
                      [buttons]="config?.buttons"
                      [loading]="performingAction$ | async"
                      [deleting]="performingDelete$ | async"
                      [validation]="validation$ | async"
                      (delete)="onDelete()"
                      (submit)="onSubmit()">
    </form-view-submit>

  </ng-container>

</ng-container>
